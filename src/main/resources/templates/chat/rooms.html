<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅방 목록</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .room { padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; }
        .room:hover { background: #f0f0f0; }
        #chatBox { margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
        #messageInput { width: 70%; padding: 5px; }
        button { padding: 5px 10px; }
    </style>
</head>
<body>

<h1>채팅방 목록</h1>

<div id="roomList">
    <div th:each="room : ${rooms}"
         th:attr="data-room-id=${room.id}, data-room-name=${room.chattingRoomName}"
         class="room"
         th:text="${room.chattingRoomName} + ' (방장: ' + ${room.master?.username} + ')'"
         onclick="enterRoom(this)">
    </div>
</div>

<hr>

<div id="chatArea" style="display: none;">
    <h2 id="roomTitle"></h2>
    <div id="chatBox"></div>
    <br>
    <input type="text" id="messageInput" placeholder="메시지를 입력하세요" />
    <button onclick="sendMessage()">전송</button>
    <button onclick="leaveRoom()">나가기</button>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;

    function enterRoom(element) {
        currentRoomId = element.getAttribute('data-room-id');
        const roomName = element.getAttribute('data-room-name');

        document.getElementById('roomTitle').textContent = roomName;
        document.getElementById('chatArea').style.display = 'block';
        document.getElementById('roomList').style.display = 'none';

        loadPastMessages();
        connectWebSocket();
    }

    function loadPastMessages() {
        fetch(`/chat/find/all/message?roomId=${currentRoomId}&page=0&size=50`)
            .then(res => res.json())
            .then(messages => {
                const chatBox = document.getElementById('chatBox');
                chatBox.innerHTML = '';
                messages.forEach(msg => addMessage(msg));
                chatBox.scrollTop = chatBox.scrollHeight;
            });
    }

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('WebSocket 연결됨');

            stompClient.subscribe('/topic/room/' + currentRoomId, function(message) {
                const chat = JSON.parse(message.body);
                addMessage(chat);
            });
        });
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message || !currentRoomId) return;

        const payload = {
            roomId: currentRoomId,
            memberId: "test-user-123",  // 테스트용 고정 ID
            message: message
        };

        stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
        input.value = '';
    }

    function addMessage(chat) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.innerHTML = `<strong>${chat.nickName}</strong>: ${chat.message} <small>(${chat.sendTime})</small>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function leaveRoom() {
        if (stompClient) stompClient.disconnect();
        document.getElementById('chatArea').style.display = 'none';
        document.getElementById('roomList').style.display = 'block';
        currentRoomId = null;
    }

    // 엔터키로 전송
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
</script>

</body>
</html>